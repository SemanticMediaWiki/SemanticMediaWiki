<?php

namespace SMW\SQLStore;

use SMW\CompatibilityMode;
use Onoi\MessageReporter\MessageReporter;
use Onoi\MessageReporter\MessageReporterAware;
use Onoi\MessageReporter\MessageReporterFactory;

/**
 * @private
 *
 * @license GNU GPL v2+
 * @since 2.5
 *
 * @author Markus KrÃ¶tzsch
 * @author Jeroen De Dauw
 * @author Nischay Nahata
 * @author mwjames
 */
class Installer implements MessageReporter, MessageReporterAware {

	/**
	 * @var TableSchemaManager
	 */
	private $tableSchemaManager;

	/**
	 * @var MessageReporter
	 */
	private $messageReporter;

	/**
	 * @since 2.5
	 *
	 * @param TableSchemaManager $tableSchemaManager
	 */
	public function __construct( TableSchemaManager $tableSchemaManager ) {
		$this->tableSchemaManager = $tableSchemaManager;
	}

	/**
	 * @see MessageReporterAware::setMessageReporter
	 *
	 * @since 2.5
	 *
	 * @param MessageReporter $messageReporter
	 */
	public function setMessageReporter( MessageReporter $messageReporter ) {
		$this->messageReporter = $messageReporter;
	}

	/**
	 * @since 2.5
	 *
	 * @param boolean $verbose
	 */
	public function install( $verbose = true ) {

		// If for some reason the enableSemantics was not yet enabled
		// still allow to run the tables create in order for the
		// setup to be completed
		if ( CompatibilityMode::extensionNotEnabled() ) {
			CompatibilityMode::enableTemporaryCliUpdateMode();
		}

		$messageReporter = $this->newMessageReporter( $verbose );

		$messageReporter->reportMessage( "\nSelected storage engine is \"SMWSQLStore3\" (or an extension thereof)\n" );
		$messageReporter->reportMessage( "\nSetting up standard database configuration for SMW ...\n\n" );

		$this->tableSchemaManager->setMessageReporter( $messageReporter );
		$this->tableSchemaManager->create();

		$messageReporter->reportMessage( "\nDatabase initialized successfully.\n" );

		return true;
	}

	/**
	 * @since 2.5
	 *
	 * @param boolean $verbose
	 */
	public function uninstall( $verbose = true ) {

		$messageReporter = $this->newMessageReporter( $verbose );

		$messageReporter->reportMessage( "Deleting all database content and tables generated by SMW ...\n\n" );
		$messageReporter->reportMessage( "Selected storage engine is \"SMWSQLStore3\" (or an extension thereof)\n\n" );

		$this->tableSchemaManager->setMessageReporter( $messageReporter );
		$this->tableSchemaManager->drop();

		$messageReporter->reportMessage( "\nStandard and auxiliary tables with its data have been removed successfully.\n" );

		return true;
	}

	/**
	 * @since 2.5
	 *
	 * @param string $message
	 */
	public function reportMessage( $message ) {
		// ob_get_level be sure to have some buffer, otherwise some PHPs complain
		if ( ob_get_level() == 0 ) {
			ob_start();
		}

		print $message;
		ob_flush();
		flush();
	}

	private function newMessageReporter( $verbose = true ) {

		if ( !$verbose ) {
			$messageReporter = MessageReporterFactory::getInstance()->newNullMessageReporter();
		} else {
			$messageReporter = MessageReporterFactory::getInstance()->newObservableMessageReporter();
			$messageReporter->registerReporterCallback( array( $this, 'reportMessage' ) );
		}

		return $this->messageReporter !== null ? $this->messageReporter : $messageReporter;
	}

}
