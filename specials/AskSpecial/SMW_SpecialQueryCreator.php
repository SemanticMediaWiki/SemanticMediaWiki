<?php

/**
 * This special page for Semantic MediaWiki implements a customisable form for
 * executing queries outside of articles.
 *
 * @file SMW_SpecialQueryCreator.php
 * @ingroup SMWSpecialPage
 * @ingroup SpecialPage
 *
 * @author Markus KrÃ¶tzsch
 * @author Jeroen De Dauw
 * @author Sergey Chernyshev
 * @author Devayon Das
 */
class SMWQueryCreatorPage extends SMWQueryUI {


	/**
	 * Constructor.
	 */
	public function __construct() {
		parent::__construct( 'QueryCreator' );
		smwfLoadExtensionMessages( 'SemanticMediaWiki' );
	}

	/**
	 * The main entrypoint. Call the various methods of SMWQueryUI and
	 * SMWQueryUIHelper to build ui elements and to process them.
	 *
	 * @global OutputPage $wgOut
	 * @param string $p
	 */
	protected function makePage( $p ) {
		global $wgOut;
		$htmlOutput = $this->makeResults( $p );
		if ( $this->uiCore->getQueryString() != "" ) {
			if ( $this->usesNavigationBar() ) {
				$htmlOutput .= Html::rawElement( 'div', array( 'class' => 'smwqcnavbar' ),
									$this->getNavigationBar ( $this->uiCore->getLimit(), $this->uiCore->getOffset(), $this->uiCore->hasFurtherResults() )
								);
			}

			$htmlOutput .= Html::rawElement( 'div', array( 'class' => 'smw-qc-result' ), $this->uiCore->getHTMLResult() );

			if ( $this->usesNavigationBar() ) {
				$htmlOutput .= Html::rawElement( 'div', array( 'class' => 'smwqcnavbar' ),
									$this->getNavigationBar ( $this->uiCore->getLimit(), $this->uiCore->getOffset(), $this->uiCore->hasFurtherResults() )
								);
			}
		}
		$wgOut->addHTML( $htmlOutput );
	}

	/**
	 * Displays a form section showing the options for a given format,
	 * based on the getParameters() value for that format's query printer.
	 *
	 * @param string $format
	 * @param array $paramValues The current values for the parameters (name => value)
	 * @param array $ignoredAttribs Attributes which should not be generated by this method.
	 *
	 * @return string
	 *
	 * Overridden from parent to ignore GUI parameters 'format' 'limit' and 'offset'
	 */
	protected function showFormatOptions( $format, array $paramValues, array $ignoredAttribs = array() ) {
		return parent::showFormatOptions( $format, $paramValues, array( 'format', 'limit', 'offset' ) );
	}
	/**
	 * Creates the input form
	 *
	 * @global OutputPage $wgOut
	 * @global string $smwgScriptPath
	 * @return string
	 */
	protected function makeResults() {
		global $wgOut, $smwgScriptPath;
		$this->enableJQuery();
		$result = "";
		$specTitle = $this->getTitle();
		$formatBox = $this->getFormatSelectBoxSep( 'broadtable' );
		$result .= '<form name="ask" action="' . $specTitle->escapeLocalURL() . '" method="get">' . "\n" .
			'<input type="hidden" name="title" value="' . $specTitle->getPrefixedText() . '"/>';
		$result .= '<br>';
		$result .= wfMsg( 'smw_qc_query_help' );
		// Main query and format options
		$result .= '<table style="width: 100%; ">' .
					'<tr><th>' . wfMsg( 'smw_ask_queryhead' ) . "</th>\n<th>" . wfMsg( 'smw_ask_format_as' ) . "</th></tr>" .
					'<tr>' .
						'<td style="width: 70%; padding-right: 7px;">' . $this->getQueryFormBox() . "</td>\n" .
						'<td style="padding-right: 7px; text-align:center;">' . $formatBox[0];

		//START: show|hide additional options
		$result .= '<span id="show_additional_options" style="display:inline;"><a href="#addtional" rel="nofollow" onclick="' .
			 "jQuery('#additional_options').show('blind');" .
			 "document.getElementById('show_additional_options').style.display='none';" .
			 "document.getElementById('hide_additional_options').style.display='inline';" . '">' .
			 wfMsg( 'smw_qc_show_addnal_opts' ) . '</a></span>';
		$result .= '<span id="hide_additional_options" style="display:none"><a href="#" rel="nofollow" onclick="' .
			 "jQuery('#additional_options').hide('blind');;" .
			 "document.getElementById('hide_additional_options').style.display='none';" .
			 "document.getElementById('show_additional_options').style.display='inline';" . '">' .
			 wfMsg( 'smw_qc_hide_addnal_opts' ) . '</a></span>';
		//END: show|hide additional options
		
		$result .=	'</td>' .
					'</tr>' .
					"</table>\n";
		// sorting and prinouts
		$result .= '<div class="smw-qc-sortbox" style="padding-left:10px;">' . $this->getPoSortFormBox() . '</div>';
		// additional options
		$result .= '<div id="additional_options" style="display:none">';

		$result .= $formatBox[1]; // display the format options

		$result .= '</div>'; // end of hidden additional options
		$result .= '<br /><input type="submit" value="' . wfMsg( 'smw_ask_submit' ) . '"/><br/>';

		$result .= '<a href="' . htmlspecialchars( wfMsg( 'smw_ask_doculink' ) ) . '">' . wfMsg( 'smw_ask_help' ) . '</a>';
		if ( $this->uiCore->getQueryString() != '' ) { // hide #ask if there isnt any query defined
			$result .= ' | <a name="show-embed-code" id="show-embed-code" href="#show-embed-code">' . wfMsg( 'smw_ask_show_embed' ) . '</a>';
			$result .= '<div id="embed-code-dialog">' .
						$this->getAskEmbedBox() .
						'</div>';
					$this->enableJQueryUI();
		$wgOut->addScriptFile( "$smwgScriptPath/libs/jquery-ui/jquery-ui.dialog.min.js" );
		$wgOut->addStyle( "$smwgScriptPath/skins/SMW_custom.css" );
				$javascriptText = <<<EOT
<script type="text/javascript">
jQuery(document).ready(function(){
	jQuery('#embed-code-dialog').dialog({
		autoOpen:false,
		buttons:{
			Ok: function(){
				jQuery(this).dialog("close");
			}
		}
	});
	jQuery('#show-embed-code').bind('click', function(){
		jQuery('#embed-code-dialog').dialog("open");
	});
});
</script>
EOT;
			$wgOut->addScript( $javascriptText );
		}
		$result .= '<input type="hidden" name="eq" value="no"/>' .
			"\n</form><br/>";

	return $result;

	}
}

